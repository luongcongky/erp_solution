'use client';

import PageTemplate from '@/components/PageTemplate';
import { useState, useEffect } from 'react';
import { useTranslations } from '@/hooks/useTranslations';
import appConfig from '@/config/app.config';
import * as XLSX from 'xlsx';
import '@/styles/datatable-common.css';
import './audit.css';

export default function AuditLogsPage() {
    const [auditLogs, setAuditLogs] = useState([]);
    const [loadingData, setLoadingData] = useState(true);
    const [error, setError] = useState(null);
    const [totalRecords, setTotalRecords] = useState(0);
    const [sortColumn, setSortColumn] = useState(null);
    const [sortDirection, setSortDirection] = useState('asc');
    const [currentPage, setCurrentPage] = useState(1);
    const [pageSize] = useState(appConfig.pagination.defaultPageSize);
    const [filters, setFilters] = useState({
        search: '',
        action: 'all',
        resource: 'all',
        dateRange: 'all'
    });
    const [showExportDialog, setShowExportDialog] = useState(false);
    const [exportFileName, setExportFileName] = useState('');
    const [isExporting, setIsExporting] = useState(false);
    const [exportProgress, setExportProgress] = useState(0);
    const { t, loading: loadingTranslations } = useTranslations();

    // Fetch audit logs from API
    useEffect(() => {
        fetchAuditLogs();
    }, [currentPage, filters]);

    const fetchAuditLogs = async () => {
        try {
            setLoadingData(true);
            setError(null);

            // Build query parameters
            const params = new URLSearchParams({
                page: currentPage.toString(),
                limit: pageSize.toString(),
            });

            if (filters.search) params.append('search', filters.search);
            if (filters.action !== 'all') params.append('action', filters.action);
            if (filters.resource !== 'all') params.append('resource', filters.resource);
            if (filters.dateRange !== 'all') params.append('dateRange', filters.dateRange);

            // Get user data from localStorage to send tenant/stage headers
            const userData = localStorage.getItem('user');
            const headers = {};
            if (userData) {
                try {
                    const user = JSON.parse(userData);
                    if (user.ten_id) headers['x-tenant-id'] = user.ten_id;
                    if (user.stg_id) headers['x-stage-id'] = user.stg_id;
                } catch (e) {
                    console.error('Error parsing user data:', e);
                }
            }

            const response = await fetch(`/api/audit?${params.toString()}`, { headers });
            const data = await response.json();

            if (data.success) {
                setAuditLogs(data.data);
                setTotalRecords(data.pagination.total);
            } else {
                setError(data.error || 'Failed to fetch audit logs');
            }
        } catch (err) {
            console.error('Error fetching audit logs:', err);
            setError('Failed to load audit logs. Please try again.');
        } finally {
            setLoadingData(false);
        }
    };

    const handleSort = (column) => {
        if (sortColumn === column) {
            setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
        } else {
            setSortColumn(column);
            setSortDirection('asc');
        }
    };

}, 500);
            } else {
    setIsExporting(false);
    setExportProgress(0);
    alert(t('pages.audit.export.noData', 'Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t'));
}
        } catch (err) {
    console.error('Error exporting to Excel:', err);
    setIsExporting(false);
    setExportProgress(0);
    alert(t('pages.audit.export.failed', 'Xu·∫•t file th·∫•t b·∫°i. Vui l√≤ng th·ª≠ l·∫°i.'));
}
    };

// Pagination (data already filtered and paginated by API)
const totalPages = Math.ceil(totalRecords / pageSize);
const startIndex = (currentPage - 1) * pageSize;

if (loadingTranslations || loadingData) {
    return (
        <div style={{
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            height: '100vh'
        }}>
            <div className="spinner"></div>
        </div>
    );
}

if (error) {
    return (
        <div style={{
            display: 'flex',
            justifyContent: 'center',
            alignItems: 'center',
            height: '100vh',
            flexDirection: 'column',
            gap: '16px'
        }}>
            <p style={{ color: 'var(--error)', fontSize: '18px' }}>{error}</p>
            <button onClick={fetchAuditLogs} className="btn btn-primary">
                {t('common.retry', 'Retry')}
            </button>
        </div>
    );
}

return (
    <PageTemplate
        breadcrumbs={[
            { label: t('modules.core', 'Core') },
            { label: t('pages.audit.title', 'Audit Logs') },
        ]}
        actions={
            <button className="btn btn-primary" onClick={handleExportClick} disabled={loadingData || isExporting}>
                {isExporting ? `Exporting... ${exportProgress}%` : t('pages.audit.exportExcel', 'Export Excel')}
            </button>
        }
        filters={
            <div className="filterBar">
                <div className="searchInputWrapper">
                    <span className="searchIcon">üîç</span>
                    <input
                        type="text"
                        placeholder={t('common.search', 'Search logs...')}
                        value={filters.search}
                        onChange={(e) => setFilters(prev => ({ ...prev, search: e.target.value }))}
                        className="searchInput"
                    />
                </div>

                <select
                    value={filters.action}
                    onChange={(e) => setFilters(prev => ({ ...prev, action: e.target.value }))}
                    className="filterSelect"
                >
                    <option value="all">{t('common.allActions', 'All Actions')}</option>
                    <option value="CREATE">{t('common.actionCreate', 'CREATE')}</option>
                    <option value="UPDATE">{t('common.actionUpdate', 'UPDATE')}</option>
                    <option value="DELETE">{t('common.actionDelete', 'DELETE')}</option>
                    <option value="LOGIN">{t('common.actionLogin', 'LOGIN')}</option>
                </select>

                <select
                    value={filters.resource}
                    onChange={(e) => setFilters(prev => ({ ...prev, resource: e.target.value }))}
                    className="filterSelect"
                >
                    <option value="all">{t('common.allResources', 'All Resources')}</option>
                    <option value="User">{t('common.resourceUser', 'User')}</option>
                    <option value="Role">{t('common.resourceRole', 'Role')}</option>
                    <option value="Customer">{t('common.resourceCustomer', 'Customer')}</option>
                    <option value="Product">{t('common.resourceProduct', 'Product')}</option>
                    <option value="System">{t('common.resourceSystem', 'System')}</option>
                </select>

                <select
                    value={filters.dateRange}
                    onChange={(e) => setFilters(prev => ({ ...prev, dateRange: e.target.value }))}
                    className="filterSelect"
                >
                    <option value="all">{t('common.allTime', 'All Time')}</option>
                    <option value="today">{t('common.today', 'Today')}</option>
                    <option value="yesterday">{t('common.yesterday', 'Yesterday')}</option>
                    <option value="last7days">{t('common.last7Days', 'Last 7 Days')}</option>
                    <option value="last30days">{t('common.last30Days', 'Last 30 Days')}</option>
                </select>

                {(filters.search || filters.action !== 'all' || filters.resource !== 'all' || filters.dateRange !== 'all') && (
                    <button
                        onClick={() => setFilters({ search: '', action: 'all', resource: 'all', dateRange: 'all' })}
                        className="clearFiltersBtn"
                    >
                        {t('pages.audit.clearFilters', 'Clear Filters')}
                    </button>
                )}
            </div>
        }
    >
        {/* Custom DataTable */}
        <div className="tableContainer">
            <div style={{ overflowX: 'auto' }}>
                <table className="dataTable">
                    <thead className="tableHeader">
                        <tr>
                            <th className="tableHeaderCell" onClick={() => handleSort('timestamp')}>
                                <div className="tableHeaderContent">
                                    {t('pages.audit.table.timestamp', 'TIMESTAMP')}
                                    {sortColumn === 'timestamp' && (
                                        <span style={{ fontSize: '0.75rem' }}>{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}</span>
                                    )}
                                </div>
                            </th>
                            <th className="tableHeaderCell" onClick={() => handleSort('user')}>
                                <div className="tableHeaderContent">
                                    {t('pages.audit.table.user', 'USER')}
                                    {sortColumn === 'user' && (
                                        <span style={{ fontSize: '0.75rem' }}>{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}</span>
                                    )}
                                </div>
                            </th>
                            <th className="tableHeaderCell" onClick={() => handleSort('action')}>
                                <div className="tableHeaderContent">
                                    {t('pages.audit.table.action', 'ACTION')}
                                    {sortColumn === 'action' && (
                                        <span style={{ fontSize: '0.75rem' }}>{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}</span>
                                    )}
                                </div>
                            </th>
                            <th className="tableHeaderCell" onClick={() => handleSort('resource')}>
                                <div className="tableHeaderContent">
                                    {t('pages.audit.table.resource', 'RESOURCE')}
                                    {sortColumn === 'resource' && (
                                        <span style={{ fontSize: '0.75rem' }}>{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}</span>
                                    )}
                                </div>
                            </th>
                            <th className="tableHeaderCell" onClick={() => handleSort('ipAddress')}>
                                <div className="tableHeaderContent">
                                    {t('pages.audit.table.ip', 'IP ADDRESS')}
                                    {sortColumn === 'ipAddress' && (
                                        <span style={{ fontSize: '0.75rem' }}>{sortDirection === 'asc' ? '‚Üë' : '‚Üì'}</span>
                                    )}
                                </div>
                            </th>
                            <th className="tableHeaderCell noSort">
                                {t('pages.audit.table.details', 'DETAILS')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        {auditLogs.map((log, index) => (
                            <tr
                                key={log.id || index}
                                className={`tableRow ${index % 2 === 0 ? 'even' : 'odd'}`}
                            >
                                <td className="tableCell timestamp">
                                    {new Date(log.timestamp).toLocaleString()}
                                </td>
                                <td className="tableCell">
                                    <div className="userInfo">
                                        <div className="userAvatar">
                                            {log.user ? log.user.charAt(0).toUpperCase() : '?'}
                                        </div>
                                        <span>{log.user || 'System'}</span>
                                    </div>
                                </td>
                                <td className="tableCell">
                                    <span className={`actionBadge ${log.action.toLowerCase()}`}>
                                        {log.action}
                                    </span>
                                </td>
                                <td className="tableCell resource">
                                    {log.resource}
                                </td>
                                <td className="tableCell ipAddress">
                                    {log.ip || '-'}
                                </td>
                                <td className="tableCell details">
                                    <div className="detailsText">
                                        {log.details || '-'}
                                    </div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>

            {/* Pagination */}
            <div className="paginationContainer">
                <div className="paginationInfo">
                    {t('common.pagination.showing', 'Showing')} {startIndex + 1} {t('common.pagination.to', 'to')} {Math.min(startIndex + pageSize, totalRecords)} {t('common.pagination.of', 'of')} {totalRecords} {t('common.pagination.results', 'results')}
                </div>
                <div className="paginationControls">
                    <button
                        onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                        disabled={currentPage === 1}
                        className="paginationButton"
                    >
                        {t('common.pagination.previous', 'Previous')}
                    </button>
                    <div className="paginationNumbers">
                        {Array.from({ length: Math.min(5, totalPages) }, (_, i) => {
                            let pageNum = i + 1;
                            if (totalPages > 5 && currentPage > 3) {
                                pageNum = currentPage - 2 + i;
                            }
                            if (pageNum > totalPages) return null;

                            return (
                                <button
                                    key={pageNum}
                                    onClick={() => setCurrentPage(pageNum)}
                                    className={`pageNumber ${pageNum === currentPage ? 'active' : ''}`}
                                >
                                    {pageNum}
                                </button>
                            );
                        })}
                    </div>
                    <button
                        onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                        disabled={currentPage === totalPages}
                        className="paginationButton"
                    >
                        {t('common.pagination.next', 'Next')}
                    </button>
                </div>
            </div>
        </div>

        {/* Export Dialog */}
        {showExportDialog && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.5)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1000
            }}>
                <div style={{
                    background: 'var(--background)',
                    padding: '32px',
                    borderRadius: '12px',
                    minWidth: '400px',
                    boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)'
                }}>
                    <h3 style={{ marginBottom: '24px', color: 'var(--text-primary)' }}>
                        Export to Excel
                    </h3>
                    <div style={{ marginBottom: '24px' }}>
                        <label style={{ display: 'block', marginBottom: '8px', color: 'var(--text-secondary)' }}>
                            File Name:
                        </label>
                        <input
                            type="text"
                            value={exportFileName}
                            onChange={(e) => setExportFileName(e.target.value)}
                            placeholder="Enter filename"
                            style={{
                                width: '100%',
                                padding: '12px',
                                borderRadius: '6px',
                                border: '1px solid var(--border)',
                                background: 'var(--input-bg)',
                                color: 'var(--text-primary)',
                                fontSize: '14px'
                            }}
                            autoFocus
                            onKeyPress={(e) => {
                                if (e.key === 'Enter') exportToExcel();
                            }}
                        />
                        <small style={{ color: 'var(--text-secondary)', marginTop: '4px', display: 'block' }}>
                            .xlsx extension will be added automatically
                        </small>
                    </div>
                    <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                        <button
                            onClick={() => setShowExportDialog(false)}
                            className="btn"
                            style={{ background: 'var(--secondary)', color: 'var(--text-primary)' }}
                        >
                            Cancel
                        </button>
                        <button
                            onClick={exportToExcel}
                            className="btn btn-primary"
                        >
                            Export
                        </button>
                    </div>
                </div>
            </div>
        )}

        {/* Loading Overlay */}
        {isExporting && (
            <div style={{
                position: 'fixed',
                top: 0,
                left: 0,
                right: 0,
                bottom: 0,
                background: 'rgba(0, 0, 0, 0.7)',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                zIndex: 1001,
                flexDirection: 'column',
                gap: '20px'
            }}>
                <div className="spinner" style={{ width: '60px', height: '60px' }}></div>
                <div style={{ color: 'white', fontSize: '18px', fontWeight: '500' }}>
                    Exporting data to Excel...
                </div>
                <div style={{ width: '300px', background: 'rgba(255, 255, 255, 0.2)', borderRadius: '10px', overflow: 'hidden' }}>
                    <div style={{
                        width: `${exportProgress}%`,
                        height: '8px',
                        background: 'linear-gradient(90deg, #667eea 0%, #764ba2 100%)',
                        transition: 'width 0.3s ease'
                    }}></div>
                </div>
                <div style={{ color: 'white', fontSize: '14px' }}>
                    {exportProgress}% complete
                </div>
            </div>
        )}
    </PageTemplate>
);
}
